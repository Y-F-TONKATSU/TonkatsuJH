<html lang='ja'>

	<head>
		
		<!--meta--writing000008-->
		
	</head>
	
	<body>
		
		<!--header--writing000008-->
					
		<div id="cont">
			
			<div class="outer">
			
				<div class="inner">
					AE の基本機能の覚書の続きです。<br>
					前回は<a href="http://ton-katsu.net#writing000007">こちら</a>。<br>
					今回はコラップストランスフォーム/<br>
					連続ラスタライズについて。
				</div>
				
			</div>
			
			<div class="outer">
			
				<div class="inner">
					<h2>コラップストランスフォームと<br>
					連続ラスタライズ</h2>
					レイヤースイッチの中に<br>
					コラップストランスフォーム/<br>
					連続ラスタライズ<br>
					というのがある。<br>
					これをオンにすると、<br>
					レンダリングオーダー<br>
					(<a href="http://ton-katsu.net#writing000007">前回</a>のテーマ)<br>
					に、少々複雑な<br>
					変更が起きる。
				</div>
				
				<div class="inner">
					主に、プリコンポーズによる<br>
					ビデオの解像度の低下や、<br>
					トランスフォームによって<br>
					ベクターグラフィックに<br>
					ジャギーが生じる問題などを<br>
					解決するのに役立つが、<br>
					レンダリングオーダーの<br>
					変更に伴い、<br>
					ちょっとした副作用が発生する。
				</div>
				
			</div>
			
			<div class="outer">
			
				<div class="inner">
					<h3>コラップストランスフォームが<br>
					必要になる状況の例:</h3>
					あるビデオを<br>
					コンポジション1に<br>
					スケール 10% で配置した後、<br>
					コンポジション1を<br>
					コンポジション2に<br>
					スケール 1000% で<br>
					配置したとする。<br>
					結果として、<br>
					コンポジション2上での<br>
					ビデオのサイズは<br>
					オリジナルと同じになるが、<br>
					10 % で配置した時に<br>
					ピクセル情報を捨てた状態から<br>
					10 倍に拡大するので、<br>
					解像度が大きく減少する。
				</div>
				
				<div class="inner">
					AE はネストされた<br>
					コンポジションを<br>
					ネストが深い階層から順に<br>
					レンダリング<br>
					(もしくはプレビュー)する。<br>
					よって、まずは<br>
					コンポジション1に含まれる<br>
					10% に縮小された<br>
					ビデオレイヤーが<br>
					レンダリングされる。<br>
					実はこの時点で、<br>
					コンポジション1は<br>
					「平らに(Flatten)」<br>
					される。
				</div>
				
				<div class="inner">
					つまり、レンダリングされた<br>
					時点でコンポジション1が<br>
					複数のレイヤーを持った<br>
					コンポジション(構成物)<br>
					であることは<br>
					忘れられて、<br>
					そのレンダリング結果を<br>
					コンテンツとする<br>
					一本のビデオシークエンスとして<br>
					扱われる。<br>
					このため<br>
					コンポジション1は<br>
					コンポジション2が<br>
					トランスフォーム時に<br>
					切り捨てた<br>
					ビデオが本来持っている<br>
					ピクセルの情報に<br>
					アクセス出来ない。
				</div>
				
			</div>
			
			<div class="outer">
			
				<div class="inner">
					ここでコンポジション2の<br>
					タイムライン上にある<br>
					コンポジション1 の<br>
					レイヤースイッチの<br>
					コラップストランスフォームを<br>
					オンにすると、<br>
					ビデオは本来の解像度に戻る。<br>
					何が起こっているのか？
				</div>
				
				<div class="inner">
					基本的に<br>
					このスイッチをオンにすると<br>
					プリコンポーズが<br>
					無かったかのように扱われる。<br>
					レンダリング時に、<br>
					コンポジションが<br>
					それを構成するレイヤー群に<br>
					分解される、<br>
					と考えることも出来る。
				</div>
				
				<div class="inner">
					では、分解される<br>
					コンポジションに設定された<br>
					トランスフォームプロパティ<br>
					(この場合はスケール)は<br>
					どうなるのか？
				</div>
				
				<div class="inner">
					分解されたレイヤーごとに、<br>
					レイヤーとコンポジションの<br>
					トランスフォーム値が<br>
					合成されたものが<br>
					適用される。<br>
					この例の場合は<br>
					「ビデオレイヤーの<br>
					スケールは 10% だけど、<br>
					コンポジションのスケールは<br>
					1000% なんで、<br>
					0.1倍の10倍は1倍だから<br>
					元のサイズってことでいいよね。」<br>
					という具合。<br>
					あくまでもレイヤーの<br>
					トランスフォームプロパティを<br>
					修正するだけで、<br>
					「平らにする(Flatten)」処理は<br>
					行わないから、<br>
					解像度は失われない。
				</div>
				
			</div>
			
			<div class="outer">
			
				<div class="inner">
					で、少々ややこしいこの機能は<br>
					「何らかの理由で<br>
					プリコンポーズしたいけど、<br>
					プリコンポーズすると<br>
					解像度が減る。」<br>
					という状況で使うわけだが、<br>
					「何らかの理由」の中には<br>
					マスクやエフェクトを<br>
					まとめて適用したい<br>
					というのが入ってくると思われる。<br>
					このときに<br>
					非常に分かり難い罠がある。
				</div>
				
				<div class="inner">
					先ほどは<br>
					「分解される<br>
					コンポジションに設定された<br>
					トランスフォームプロパティ」<br>
					について述べたが、<br>
					コンポジション1に<br>
					トランスフォームだけでなく<br>
					マスクやエフェクトが<br>
					設定されていた場合が<br>
					問題である。
				</div>
				
				<div class="inner">
					コラップストランスフォームを<br>
					オンにすると、<br>
					「平らにする(Flatten)」処理は<br>
					行われない、<br>
					と書いたばかりだが、<br>
					実は AE は全てのレイヤーの<br>
					トランスフォームを<br>
					再計算した時点で、<br>
					分解したコンポジションを<br>
					もう一度コンポーズしていて、<br>
					マスクとエフェクトの処理は<br>
					この再構成されて<br>
					「平にされた(flattened)」<br>
					コンポジションに適用される。<br>
					つまり、マスクとエフェクトは<br>
					トランスフォームのように<br>
					個別には計算されない。
				</div>
				
				<div class="inner">
					コラップストランスフォーム<br>
					が適用されたレイヤーの<br>
					レンダリングオーダーを<br>
					まとめると<br>
					<br>
					1. コンポジションを分解<br>
					<br>
					2. レイヤーのマスク、<br>
					エフェクト、<br>
					トランスフォームを適用<br>
					<br>
					3.コンポジションの<br>
					トランスフォームを元に<br>
					レイヤーの<br>
					トランスフォームを修正<br>
					<br>
					(全てのレイヤーを処理するまで
					2～3 を繰り返す。)<br>
					<br>
					・コンポジションを再構成<br>
					<br>
					・コンポジションに<br>
					マスク、エフェクトを適用<br>
					<br>
					となる。
				</div>
				
			</div>
			
			<div class="outer">
			
				<div class="inner">
					ところで<a href="http://ton-katsu.net#writing000007">前回</a>、<br>
					レイヤーのレンダリングは<br>
					・マスク<br>
					・エフェクト<br>
					・トランスフォーム<br>
					・レイヤースタイル<br>
					の順に行われると書き、<br>
					例外があるとも書いたが、<br>
					その例外がまさにこれである。
				</div>
				
				<div class="inner">
					この場合は、<br>
					・トランスフォーム<br>
					・マスク<br>
					・エフェクト<br>
					・レイヤースタイル<br>
					の順になるため、<br>
					エフェクトなどが<br>
					予想外の振る舞いをする<br>
					可能性がある。
				</div>
				
			</div>
			
			<div class="outer">
			
				<div class="inner">
					<img src="article_image/1411/collapse.jpg" alt="エフェクトの振る舞いがコラップストランスフォームの影響を受ける例">
				</div>
				
				<div class="inner">
					上図は、ネストされた<br>
					コンポジションに<br>
					ドロップシャドウエフェクト<br>
					(180°)を付けて、<br>
					90°回転させたレイヤーを<br>
					複製して、<br>
					一方は<br>
					コラップストランスフォームを<br>
					オフ(左)に、<br>
					もう一方は<br>
					オンにしたもの(右)である。<br>
					オフにした方は<br>
					影が付いたものが<br>
					回転しており、<br>
					オンにした方は<br>
					回転したものに<br>
					影が付いている。<br>
					コラップストランスフォームにより<br>
					レンダリングオーダーが<br>
					変わることで<br>
					副作用が出ているのが分かる。<br>
					(なお、レイヤースタイルは<br>
					常にトランスフォームよりも<br>
					後でレンダリングされるため、<br>
					この副作用はない。)
				</div>
				
			</div>
			
			<div class="outer">
			
				<div class="inner">
					<h2>連続ラスタライズ</h2>
					コラップストランスフォームの<br>
					レイヤースイッチは<br>
					コンポジション以外にも<br>
					・テキストレイヤー<br>
					・シェイプレイヤー<br>
					・平面レイヤー<br>
					・Illustrator や Flash から<br>
					インポートしたレイヤー<br>
					等、要するに<br>
					ベクター系グラフィックが<br>
					含まれるレイヤーにも適用できて、<br>
					その場合は<br>
					連続ラスタライズスイッチ<br>
					と呼ばれる。<br>
					(テキストレイヤーと<br>
					シェイプレイヤーは<br>
					強制的にオンになる。)
				</div>
				
				<div class="inner">
					周知の通り、<br>
					拡大しても<br>
					エッジにジャギーが出ないことが<br>
					ベクターグラフィックの<br>
					大きな利点の一つである。<br>
					ところが、<br>
					Illustrator から<br>
					インポートしたレイヤーや<br>
					平面レイヤーの<br>
					スケールプロパティを<br>
					増やして大きくしてみると、<br>
					エッジにジャギーが出てしまう<br>
					ことが確認できる。
				</div>
				
				<div class="inner">
					なぜかといえば、<br>
					ベクターレイヤーは<br>
					トランスフォームの影響を<br>
					受ける前の段階で<br>
					ラスタライズ(ビットマップ化)<br>
					されてしまうので、<br>
					トランスフォームによる<br>
					変形に際しては<br>
					ベクターグラフィックであることの<br>
					恩恵を受けられないのである。<br>
					(予め Illustrator の<br>
					アートボードを大きく作っておく、<br>
					みたいな力技の解決方法も<br>
					無くはない。)
				</div>
				
			</div>
			
			<div class="outer">
			
				<div class="inner">
					ここで、<br>
					連続ラスタライズスイッチを<br>
					オンにすると、<br>
					トランスフォームが<br>
					ラスタライズの処理の前に<br>
					行われるようになり、<br>
					結果ジャギーは解消される。
				</div>
				
				<div class="inner">
					そして、<br>
					レンダリングオーダーが<br>
					・トランスフォーム<br>
					・(ラスタライズ)<br>
					・マスク<br>
					・エフェクト<br>
					・レイヤースタイル<br>
					のように変わる結果、<br>
					ここでも<br>
					コラップストランスフォーム<br>
					の場合と同様の<br>
					副作用が生じて、<br>
					エフェクトの振る舞いが<br>
					変化する可能性がある。
				</div>
				
			</div>
			
		</div>
		
		<!--footer--writing000008-->
		
	</body>
	
</html>		